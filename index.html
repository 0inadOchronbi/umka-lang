<!DOCTYPE html>
<html>
    <body>
        <p style="font-family:arial; font-size:24px">The Umka playground</p>
        <button id="runButton">Run</button>
        <br><br>
        <textarea id="sourceTextArea" rows="20" cols="80"></textarea>
        <br><br>
        <textarea id="outputTextArea" rows="10" cols="80"></textarea>

        <script>
            var runButton = document.getElementById("runButton")
            var sourceTextArea = document.getElementById("sourceTextArea")
            var outputTextArea = document.getElementById("outputTextArea")

            sourceTextArea.value = 

`fn main() {
    printf("Hello World\\n")
}`
            
            sourceTextArea.onkeydown = onTab  
            runButton.onclick = onRun

            var Module = {'print': onPrint, 'printErr': onPrintErr}            

            function onTab(e) 
            {
                if (e.key == 'Tab') 
                {
                    e.preventDefault()
                    var start = this.selectionStart
                    var end = this.selectionEnd

                    this.value = this.value.substring(0, start) + "    " + this.value.substring(end)
                    this.selectionStart = this.selectionEnd = start + 4
                }
            }

            function onPrint(text)
            {
                outputTextArea.value += text + '\n'
            }

            function onPrintErr(text)
            {
                onPrint(text)
                
                var words = text.split(' ')
                if (words[0] != "Error" || typeof(words[2]) == "undefined")
                    return

                var lineNum = words[2].replace(',', '').replace('(', '')
                selectLine(lineNum)
            }            

            function onRun()
            {
                runPlayground = Module.cwrap('runPlayground', 'number', ['string', 'string'])
                source = sourceTextArea.value
                outputTextArea.value = ""
                runPlayground("playground.um", source)
            }

            function selectLine(lineNum) 
            {
                lineNum--
                var lines = sourceTextArea.value.split("\n")

                var startPos = 0, endPos = sourceTextArea.value.length
                for (var x = 0; x < lines.length; x++) 
                {
                    if (x == lineNum)
                        break;
                    startPos += lines[x].length + 1
                }

                var endPos = lines[lineNum].length + startPos

  
                if (typeof(sourceTextArea.selectionStart) != "undefined") 
                {
                    sourceTextArea.focus()
                    sourceTextArea.selectionStart = startPos
                    sourceTextArea.selectionEnd = endPos
                    return true
                }

                return false
            }            
        </script>

        <script src="playground/umka.js"></script>
    </body>
</html>